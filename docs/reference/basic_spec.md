# 基本仕様書（Reference）
- Doc Type: Reference（Diátaxis）
- 対象: 実装者 / レビュア / Codex（Issue起票）/ テスト設計
- 目的: 「アプリが何をするか」を、ズレにくい粒度で“正”として置く（= 実装・テスト・運用の共通言語）
- 正（Source of Truth）:
  - 依存関係/SDK/バージョン: package.json（本書に固定記載しない）
  - 受け入れ条件（合否）: Jest テスト（__tests__/ 配下）
  - UIの正: Figma（リンクで参照。本文にUI細部を書きすぎない）
  - 意思決定の理由: ADR（docs/adr/）
  - 前提/制約の一枚岩: constraints（docs/reference/constraints.md）
- 更新トリガ:
  - 仕様変更PRで「本書 or テスト or ADR」のどれを更新したかが説明できない場合はNG

---

## 1. プロダクト概要
### 1.1 一言で
DotChain は、毎日の「やった/やってない」を最短操作で記録し、継続（チェーン）を可視化して習慣化を助けるアプリ。

### 1.2 コア価値（不変条件）
- ユーザーの主目的は「**その日の実行を1タップで記録**」すること
- 記録は「**日付単位（ローカル日付）**」で扱う（UTCではなく端末ローカル基準）
- 可視化は「**続けた事実が気持ちよく見える**」ことを最優先する
- 基本はオフラインで成立する（= 記録がネットワークに依存しない）

### 1.3 スコープ（今回 / 将来）
#### 今回（v1: 現行実装の範囲）
- 習慣の作成/編集/削除
- 今日の達成トグル（ON/OFF）
- 指標表示（連続日数・完全達成日数）
- ヒートマップ表示（一定日数レンジ）
- 設定（テーマ、効果音、バイブ、ヒートマップレンジ、電流表現、リマインダー、レビュー依頼）
- 多言語対応（18言語）
- Pro（サブスク）購入/復元（RevenueCat）
- 7日連続達成時のレビュー依頼（可能な端末のみ）

#### 将来（今回は含めない）
- AdMob 広告（次回マスト。仕様は constraints + ADR + テストで管理）
- クラウド同期（アカウント/サーバ保存）
- ウィジェット、共有、ランキング等
- 詳細な分析/BI（行動ログ収集）

---

## 2. 用語（詳細は glossary を正とする）
- 習慣（Habit）: 継続したい行動の単位
- ログ（Log）: ある習慣をある日付に達成した記録
- 日付キー（DateKey）: "YYYY-MM-DD" の文字列。端末ローカル日付で生成する
- 連続日数（Streak）: 今日から過去に向かって「1つでも達成がある日」が続いた日数
- 完全達成日（All Done Day）: その日に存在していた全習慣を達成できた日

---

## 3. 対応プラットフォーム
- iOS / Android を対象
- 最低対応OSは Expo SDK の要件に従う（正は Expo 公式と package.json）
- 端末のローカル時刻/タイムゾーンに依存する（DateKey の算出）

---

## 4. 機能要件（Feature）
> 受け入れ条件（合否）は「Jest テスト」を正とする。  
> ここでは「何ができるか」を短く定義し、細部はテスト/ADR/参照へ分離する。

### F-01 習慣実行の記録（Habit Record）
#### できること
- 習慣一覧から、習慣をタップして「今日やった」を ON/OFF できる
- ON のときは達成演出（音/振動）を出せる（設定で無効化可）
- 記録は「日付キー」で保存する（同じ日付に同じ習慣のログは最大1件）

#### 受け入れ条件（例）
- 1回タップで今日が ON になり、2回目で OFF に戻る
- DBエラー時は状態が壊れず、エラー表示用の状態が立つ
- 同一日付・同一習慣に重複ログが作られない

#### 関連テスト
- __tests__/F01_habitRecord.test.ts

---

### F-02 指標（Metrics）とヒートマップ（Heatmap）
#### できること
- 連続日数（Streak）を計算して表示できる
- 完全達成日数（All Done Days）を計算して表示できる
- 日付ごとの達成数（何件達成したか）を可視化できる
- ヒートマップ表示期間を選べる（設定で 7/30/60/180/365 日）

#### 受け入れ条件（例）
- 習慣数とログから、日付ごとの達成件数が再現可能
- ストリークが仕様通りに数えられる
- 完全達成日が仕様通りに数えられる

#### 関連テスト
- __tests__/F02_habitMetrics.test.ts

---

### F-03 設定（Settings）
#### できること
- 効果音 ON/OFF
- 振動 ON/OFF
- テーマ選択（dark / neonPink / cyberBlue）
- タップ音の種類選択
- ヒートマップ表示期間の選択
- 電流表現（electricFlow）の ON/OFF（期間によって初期値が変わる）
- リマインダー（毎日1回のローカル通知）ON/OFF、時刻変更
- Pro 購入の復元（Restore Purchases）
- デバッグ用ユーティリティ（開発向け）

#### 受け入れ条件（例）
- 設定はアプリ再起動後も保持される（today のような日付依存の一時状態は除く）
- リマインダーON時は権限確認を行い、拒否された場合はONにならない
- ヒートマップ期間変更で electricFlow の挙動が仕様通り

#### 関連テスト
- __tests__/F03_settingsStore.test.ts

---

### F-04 オンボーディング / チュートリアル
#### できること
- 初回導入時に基本操作の導線を提示できる
- 一度見たことを記録して、毎回は邪魔しない

#### 受け入れ条件（例）
- 初回のみ表示され、以後は表示されない（必要なら設定で再表示できる設計を許容）

---

### F-05 多言語対応（i18n）
#### できること
- アプリ内の表示テキストが端末言語（またはアプリ内言語選択）で切り替わる
- 対応言語（実装の正）:
  - en, ja, fr, es, de, it, pt, ru, zhHans, zhHant, ko, hi, id, th, vi, tr, nl, sv

#### 受け入れ条件（例）
- 言語コードは実装に一致する（特に nl はオランダ語として正）
- 主要導線（ホーム/追加/設定/Pro）の文言が欠落しない（欠落キーは検知できる）

---

### F-06 Pro（サブスクリプション）
#### できること
- Pro 画面で月額/年額プランを購入できる
- 購入状態（Proかどうか）をアプリ内で判定できる
- 購入の復元（Restore）を提供する

#### 不変条件
- 課金の正はプラットフォーム（App Store / Google Play）＋ RevenueCat に従う
- Pro の「何が解放されるか」は constraints + ADR + テストで定義し、本書は概略のみ

#### 受け入れ条件（例）
- 購入成功で Pro 状態になる
- 復元で Pro 状態を再取得できる
- 購入できない/オファリング取得失敗時にユーザーが迷子にならない（メッセージ表示）

---

### F-07（将来）AdMob 広告
- 今回は未実装（次回からマスト）
- 仕様は docs/reference/constraints.md と ADR とテストで管理する（本書に細部を固定しない）

---

### F-08 レビュー依頼（In-App Review）
#### できること
- 7日連続達成時に、端末が対応していればレビュー依頼を行う
- 依頼は原則「端末1回」に抑制する

#### 受け入れ条件（例）
- streak == 7 のタイミングで依頼条件が true になる
- 既に依頼済みなら再度依頼しない
- 端末が非対応の場合は何もしない

#### 関連テスト
- __tests__/F08_reviewRequest.test.ts

---

## 5. データ要件（ローカル永続化）
### 5.1 保存方針（不変条件）
- 基本データは端末ローカルに保存し、ネットワーク前提にしない
- 習慣とログは SQLite に保存する
- 設定はローカルストレージに保存する
- 「今日の達成状態」のような日付依存の一時状態は“ズレ”の原因なので、原則永続化しない（必要なものだけ永続化）

### 5.2 データモデル（概略）
- habits:
  - id, title, icon, color, createdAt
- logs:
  - id, habitId, date(YYYY-MM-DD), timestamp
  - (habitId, date) は一意

---

## 6. 非機能要件（NFR）
### 6.1 UX/性能
- 「記録」は最短操作（= 迷わせない、待たせない）
- 表示/操作は基本オフラインで成立する
- エラー時も状態が壊れない（データが消えない/二重化しない）

### 6.2 アクセシビリティ（最低ライン）
- 文字が読めるコントラストを確保する（テーマ設計の責務）
- タップ領域を極端に小さくしない
- 音/振動は設定でOFF可能

### 6.3 セキュリティ/プライバシー（最低ライン）
- 個人情報の入力を必須にしない（アカウント不要）
- 課金はプラットフォームの仕組みに従う
- 収集する情報（もし増えるなら）は constraints + ADR で定義し、ユーザーに明示する

---

## 7. 仕様の活かし方（運用ルール）
- 仕様（本書）は短く保つ（= “何ができるか” の地図）
- 理由/背景/比較検討は ADR に書く（蒸し返し防止）
- 合否は Jest テストで固定する（= 仕様と実装の整合が崩れにくい）
- UIの詳細は Figma を正にしてリンクで参照する（本書に固定しすぎない）

---

## 8. 参照（一次情報リンク）
- Expo SDK の対応OS（正）: https://docs.expo.dev/versions/latest/
- Diátaxis（文書4分類）: https://diataxis.fr/
- RevenueCat（課金・復元の考え方）: https://www.revenuecat.com/docs/
- GitHub Docs（docs-as-code 運用）: https://docs.github.com/
