# 機能設計書（DotChain）

## 0. この文書の位置づけ（超重要）
- 文書タイプ：Reference（「どう動くか」をすぐ引けるための仕様）
- 想定読者：
  - 実装する人（未来の自分 / AI）
  - PRレビューする人
  - 不具合を切り分ける人
- この文書に「書かない」こと（ドリフト防止）：
  - 開発手順・コマンド（→ docs/how-to/whole_workflow.md）
  - 背景や思想の長文（→ docs/adr/）
  - 画面の見た目詳細（→ 画面設計書 / Figma）
- ソース・オブ・トゥルース（正）：
  1) この機能設計書（期待動作）
  2) 自動テスト（期待動作の機械的検証）
  3) 実装（最終的な現実）
  ※ 1) と 2) が揃って初めて「仕様が生きている」とみなす

## 1. いつ・どんな時に必要になる？
- 仕様を元にIssueを立てる時：
  - 「受け入れ条件」をここからコピペする
- 実装前：
  - 既存機能の期待動作を確認し、影響範囲（どの機能IDに触れるか）を特定する
- PRレビュー時：
  - 変更内容が、この文書の期待動作を壊していないか確認する
- 不具合調査時：
  - 「本来どう動くべきか」をここで確定し、ログ/再現手順を組み立てる

## 2. 更新ルール（運用で死なせない）
### 2.1 更新トリガー（1つでも当てはまれば更新）
- 新しい画面・設定項目・制約が増えた
- 既存の挙動（例：連続日数の定義、無料制限）が変わった
- テストの期待値が変わった
- Pro/課金/広告/レビュー要求など、審査に関わる動作が変わった

### 2.2 PRのDefinition of Done（この文書に関する最低条件）
- [ ] 変更した機能ID（F-xx）をPRに列挙した
- [ ] 受け入れ条件が変わるなら、この文書を更新した
- [ ] 関連テスト（Jest / Maestro）が追加・更新され、CIで実行される

（推奨：docs配下の変更は CODEOWNERS でレビュー要求）
- 参考：https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners
- ブランチ保護（必須レビュー/必須CI）：
  - 参考：https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches

## 3. 全体の機能マップ（機能ID）
- F-01：習慣（Habit）管理（作成/編集/削除/並び替え）
- F-02：日次チェック（今日の達成・進捗・連続日数）
- F-03：設定（言語/テーマ/ヒートマップ期間/リマインダー/チュートリアル）
- F-04：Pro（課金・復元・Pro制限解除）
- F-05：ヒートマップ（直近N日、強度表示）
- F-06：チュートリアル（初回導線）
- F-07：広告（AdMob）（※計画中：現状は未実装/無効）
- F-08：レビュー要求（一定条件で in-app review を促す）

## 4. 用語（この文書で使う言葉）
- Habit：習慣。タイトル/色/アイコンなどの属性を持つ
- Log：ある日付に、そのHabitを「やった/やってない」を記録したもの
- dateKey：ローカル日付を `YYYY-MM-DD` で表したキー
- doneDays：1つでも習慣を達成した日（dateKeyの集合）
- streak：今日から遡って連続して doneDays に含まれる日数
- intensity：ある日の「達成した習慣数」
- maxIntensity：その日の「存在する習慣数」（分母）

## 5. 横断仕様（どの機能にも効くルール）
### 5.1 日付の基準
- 日付境界は端末のローカルタイム（00:00切り替え）を基準とする
- アプリがバックグラウンドにいても、復帰時に日付変更を検知して当日情報を再同期する
- リスク：端末の手動時刻変更 / タイムゾーン変更で意図しない日付が混ざる可能性
  - 対策（仕様）：まずは「ローカル基準」と明記し、将来必要ならADRで「旅行対応」などを決める

### 5.2 データの正（DB）とキャッシュ（状態）
- 正：ローカルDB（Habit/Log）
- 画面表示用：アプリ状態（ストア）にキャッシュを持つ
- 原則：表示はキャッシュで高速に、永続化はDBで確実に

### 5.3 エラー時の原則
- ユーザー操作の結果が保存できなかった場合：
  - 画面に分かる形で通知する（トースト等）
  - 可能なら「元に戻す」または「再試行導線」を用意する
- 課金/復元は失敗しうる前提で、明確なメッセージを出す

---

# F-01 習慣（Habit）管理

## 目的
ユーザーが「続けたい習慣」を登録し、後から編集・削除・並び替えできるようにする。

## 画面/入口
- Home（一覧表示）
- 習慣追加/編集画面

## 期待動作（仕様）
### 作成
- 必須：タイトル（空は禁止）
- 任意：色、アイコン（未指定時はデフォルト）
- 作成後：
  - Homeの一覧に反映される
  - 今日の進捗（F-02）の分母（maxIntensity）に含まれる

### 編集
- タイトル/色/アイコンの更新ができる
- 編集後：
  - Home表示が更新される
  - 過去のLog（達成履歴）は保持される（Habit IDが同一のため）

### 削除
- 削除確認がある（誤操作対策）
- 削除後：
  - Home一覧から消える
  - （仕様方針）そのHabitの過去Logは削除する or 保持するを明確化する
    - v1方針：削除に追随してLogも削除（「存在しない習慣の履歴」を残さない）
    - ※方針変更する場合はADR化する

### 並び替え
- ユーザーは表示順を変更できる
- Homeはその順で表示する

## 制約（無料/Pro）
- 無料ユーザーは登録できる習慣数に上限がある（例：3）
- 上限に到達している場合：
  - 新規作成はできない
  - Pro誘導（F-04）を提示する

## 受け入れ条件（Issueにコピペ用）
- [ ] タイトル空の習慣は作成できない
- [ ] 作成/編集/削除がHomeに即反映される
- [ ] 無料上限時は作成できず、Pro導線が出る

## 対応テスト（例）
- Jest：F-01-01 / F-01-02 / F-01-03（作成・編集・削除）
- Maestro：smoke（基本導線）

---

# F-02 日次チェック（今日の達成・進捗・連続日数）

## 目的
ユーザーが「今日その習慣をやった」を簡単に記録でき、進捗と連続日数が見える。

## 画面/入口
- Home（習慣一覧・トグル）
- （必要なら将来）日別詳細画面

## 期待動作（仕様）
### 今日の達成トグル
- 習慣ごとに「今日やった/やってない」を切り替えできる
- 切り替え結果は即時にUIへ反映される
- 永続化（DB）に成功して初めて確定とみなす

### 進捗（例：リング/数値）
- intensity = 今日達成した習慣数
- maxIntensity = 今日存在する習慣数
- 表示例：
  - `3 / 7` のように分子/分母で表示しても良い

### doneDays（達成日）
- その日（dateKey）に1つでも達成ログがあれば、その日は doneDays に含める

### streak（連続日数）
- 今日から遡って、連続して doneDays に含まれる日数
- 今日が未達成（doneDaysに含まれない）なら streak は 0 から始まる（または昨日から再計算）
  - ※ここは「ユーザー体験に直結」するので、期待値を固定する（曖昧にしない）

### 日付切り替わり（00:00）
- 00:00を跨いだら「今日」が変わる
- バックグラウンド復帰時も日付変更を検知し、当日の状態に同期する

## 受け入れ条件
- [ ] トグル操作で今日の達成が記録される
- [ ] 進捗（intensity/maxIntensity）が正しい
- [ ] streak の定義が仕様通りで、7日連続などの判定に使える
- [ ] 日付が変わったら自動的に当日状態へ切り替わる

## 対応テスト（例）
- Jest：F-02-01（記録）/ F-02-02（streak）
- Maestro：smoke

---

# F-03 設定（言語/テーマ/ヒートマップ期間/リマインダー/チュートリアル）

## 目的
ユーザーが「自分好みに」アプリ体験を調整できる。

## 設定項目（期待動作）
### 言語
- アプリ表示言語を選択できる
- 選択後、主要画面のテキストが切り替わる
- 対応言語は別紙（constraints）または本項に列挙して固定する

### テーマ
- 複数テーマから選択できる
- 一部テーマはPro限定にできる（F-04と連動）

### ヒートマップ期間（F-05と連動）
- 直近N日（例：7/30/90/180/365）を選べる
- 365など重い期間はPro限定にできる（F-04と連動）

### リマインダー（ローカル通知）
- ON/OFF と 通知時刻（時:分）を設定できる
- ONの場合：
  - 毎日同じ時刻に通知する（ローカル通知）
- OFFの場合：
  - 予約済み通知は解除される

### チュートリアル
- チュートリアルの進行状態を保持する
- 必要なら「最初からやり直す」導線を用意する

## 受け入れ条件
- [ ] 言語変更で主要UIが切り替わる
- [ ] Pro限定項目は無料で選べず、Pro導線が出る
- [ ] リマインダーONで毎日通知、OFFで解除される

## 対応テスト（例）
- Jest：F-03-01（テーマ/設定）
- （推奨）通知はユニットで難しいため、モック前提でテスト方針を別途定義

---

# F-04 Pro（課金・復元・Pro制限解除）

## 目的
無料制限を解除し、継続課金（サブスク）を成立させる。

## 期待動作（仕様）
- Pro購入導線（Paywall）を表示できる
- 購入：
  - 成功→Pro状態になる（制限解除）
  - 失敗→エラー表示
- 復元（Restore Purchases）：
  - 過去購入がある場合→Proに戻る
  - 無い場合→その旨を表示

## Proで解除されるもの（例）
- 習慣数の上限
- ヒートマップ長期表示
- Pro限定テーマ

## 受け入れ条件
- [ ] 購入成功で制限が解除される
- [ ] 復元でProに戻れる
- [ ] 購入失敗時に分かるエラーが出る

---

# F-05 ヒートマップ（直近N日、強度表示）

## 目的
「続いている感」を可視化し、継続を後押しする。

## 期待動作（仕様）
- dateKeyを横方向に並べたグリッド表示
- 各日の強度：
  - intensity = 達成した習慣数
  - maxIntensity = 習慣数
  - 表示は「強度（濃淡/高さ）」などで表す
- 期間Nは設定（F-03）に従う
- 長期（例：365）はPro限定にできる

## 受け入れ条件
- [ ] 設定した期間Nに応じて表示範囲が変わる
- [ ] intensity/maxIntensity が仕様通りである

---

# F-06 チュートリアル（初回導線）

## 目的
初見ユーザーが迷わず「習慣を作る→達成する→連続を見る」に到達できる。

## 期待動作（仕様）
- 初回または未完了時、画面上にガイド（吹き出し/ハイライト）を表示する
- ステップは保存され、再起動しても継続できる
- 完了後は通常表示に戻る

## 受け入れ条件
- [ ] 初回にチュートリアルが出る
- [ ] 進行状態が保持される
- [ ] 完了後は出ない（必要なら設定で再表示できる）

---

# F-07 広告（AdMob）※計画中

## 方針（現状）
- v1では広告は未実装（または無効）
- 将来追加する場合：
  - 表示場所（Home下部など）
  - 表示頻度
  - Proで広告解除
  - 審査・ポリシー対応
を ADR で確定してから実装する

---

# F-08 レビュー要求（in-app review）

## 目的
ユーザー満足が高いタイミングで、ストアレビューを自然に促す。

## トリガー（例）
- streak が 7 に到達した時に1回だけ表示する
- 既に要求済みなら二度と出さない（フラグで管理）

## 期待動作（仕様）
- 対応端末/環境でのみレビュー要求を試みる
- 失敗しても致命的なエラーにしない（静かに無視 or ログ）

## 受け入れ条件
- [ ] 7日連続到達でレビュー要求が発火する
- [ ] 1回要求済みなら二度と発火しない
- [ ] 未対応環境では何もしない

## 対応テスト（例）
- Jest：F-08-01（トリガー条件）

---

## 付録：この文書を“生かし続ける”ためのチェック（最短版）
- 機能追加・挙動変更したら、必ず「該当F-xxの章」を更新する
- テスト（Jest/Maestro）と「受け入れ条件」をセットで更新する
- docs変更はレビュー必須にする（CODEOWNERS + ブランチ保護）
