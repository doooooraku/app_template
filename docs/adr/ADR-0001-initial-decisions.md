# ADR-0001: 初期の決定事項（ベースライン）を ADR/constraints に集約する

- Status: Accepted
- Date: 2026-01-17
- Deciders: DotChain core
- Scope: DotChain v1.x（仕様のベースライン）
- Related:
  - docs/reference/constraints.md（前提/制約の正）
  - docs/adr/README.md（ADR運用ルール）
  - docs/adr/adr_template.md（ADRテンプレ）
  - docs/reference/basic_spec.md / docs/reference/functional_spec.md / docs/reference/constraints.md（初期仕様の参照元）

---

## 0. このADRは「何のためにある？」（超重要）

この ADR-0001 は、DotChain の「もう決まっていること（=ブレない土台）」を **“初期の基準点”** として残すための文書です。

### 0-1. いつ読む？
- 仕様を見直すとき（「これって決まってたっけ？」となった時）
- 新しい機能を入れる前（既存の制約にぶつからないか確認する）
- PRレビュー時（変更が “土台” を壊していないか確認する）
- 仕様書が古くなって迷子になった時（まずここへ戻る）

### 0-2. いつ更新する？
この ADR-0001 自体は、**基本的に更新しません**。  
もし「初期の土台」を変更するなら、**新しいADRを作って “差分” と “理由” を書き**、この ADR を `Superseded`（置き換え）にします。

> 例：広告方針を変える → 新ADR（例：ADR-0008）で決める → constraints を更新 → テスト/CIを更新 → ADR-0001 を Superseded にする

---

## 1. Context（背景 / なぜ必要？）

過去、仕様書が形骸化した原因は次の“合わせ技”だった。

- 更新すべき範囲が広すぎた（＝ズレやすい情報まで仕様書に書いてしまった）
- 更新を強制する仕組みが無かった（＝更新漏れが起きても止まらない）

その結果、仕様書と実装がズレて「どれが正？」が分からなくなった。

---

## 2. Decision（何を決めた？）

### 2-1. 「正（ソース・オブ・トゥルース）」の優先順位を固定する

矛盾したら、次の順で正とする。

1) **コード（実装）**：動いている事実  
2) **docs/reference/constraints.md**：プロダクト/設計の前提と制約（ルールブック）  
3) **ADR（docs/adr/）**：なぜそう決めたか（理由/比較/却下案/影響）  
4) その他の仕様書（0〜7）：参考（古い可能性がある）

> ねらい：仕様書本文を “軽く” 保ち、ズレの温床を減らす。

---

### 2-2. プロダクトの不変条件（変えない「核」）

#### (A) ローカル志向（Local-first）
- DotChain は **ローカル志向の習慣トラッカー** とする（自前バックエンドを持たない）
- **ユーザー登録（メール/パスワード）を持たない**

#### (B) データ保存は「端末内のみ」
- Habit / HabitLog：SQLite
- Settings / ProState：SecureStore（OSの暗号化ストレージ）
- v1.0 時点で **「全データ削除」ボタンは持たない**（原則アンインストール）

---

### 2-3. 収益モデル（Free/Pro）と広告/課金の方針

#### (A) 収益は2本柱
- **サブスクリプション（Pro）**
- **広告（Free向けバナー）**

#### (B) Free / Pro の不変差分
- Free：習慣は **3つまで**
- Pro：習慣は **無制限**
- Pro：広告は出さない（広告コンポーネントをマウントしない）
- 課金は RevenueCat 経由、復元（Restore）を提供

#### (C) 広告ポリシー（重要）
- **全画面広告（インタースティシャル）は採用しない**
- **次回リリース以降**：Free にバナー広告（AdMob）を必ず組み込む（Pro は常に広告ゼロ）
- 開発中は **テスト広告ユニット** を使う（本番広告を開発で表示しない）
- 本番の広告ユニットIDは **ソースに直書きしない**（設定から注入）

---

### 2-4. i18n（言語/レイアウト）の方針

- v1.x は **18言語対応**
- アラビア語は除外（RTL対応しないため）
- レイアウトは **LTRのみ**（RTLはサポート外）
- 言語コードは **BCP47準拠**を前提とし、**オランダ語は `nl` を正**とする

---

### 2-5. 文言（Paywall等）に関する方針

- Paywall / Pro画面で「将来実装予定」を書かない
  - 「近日追加予定」「Coming soon」などは禁止
  - **現時点で実装済みの挙動のみ** を説明する

> ねらい：仕様と実装のズレを“言葉”で増やさない。

---

### 2-6. ドキュメント運用（docs-as-code）と品質ゲート

- ドキュメントもコードと同様に、Git/PR/CIで運用する（docs-as-code）
- ブランチ保護を設定し、**CIが落ちたらマージ不可**にする
- PRテンプレを用い、変更の目的/影響/テスト/ドキュメント更新を毎回書く
- “合否（受け入れ条件）” は **テスト（自動）** を正に寄せる
  - 最低ライン：Jest（ユニット/ロジック）＋ CI の必須チェック

---

## 3. Consequences（何が嬉しい？何が辛い？）

### 3-1. 嬉しいこと（メリット）
- 「何が正？」が一発で決まる（迷子が減る）
- 仕様書を全部更新しなくてよくなる（ズレにくい）
- 変更がPR/CIで止まる（更新漏れが構造的に減る）
- Codex/人間の両方が参照しやすい（判断材料が短い）

### 3-2. 辛いこと（コスト）
- 変更のたびに「ADRを書く」手間が増える
- constraints と ADR の“書き分け”に慣れが必要
- テスト整備が弱いと「合否をテストに寄せる」が機能しない

---

## 4. Alternatives considered（他の案と却下理由）

- 仕様書に全部を詳しく書く案  
  → 更新漏れが再発しやすい（今回の反省に反する）

- バックエンド＋アカウントを持つ案  
  → プライバシー/運用コスト/仕様が重くなる（v1.x方針に反する）

- 広告を全画面広告中心にする案  
  → 体験が悪化しやすい（方針として不採用）

- RTL対応を最初からやる案  
  → UI/実装コストが跳ねる（v1.xではスコープ外）

---

## 5. Risks（リスク）と対策（恒久策）

### リスク1：ADRを書かなくなる（形骸化）
- 対策（恒久策）：
  - PRテンプレの必須項目に「ADR必要？」チェックを置く
  - ブランチ保護で「必須チェック」を通さないとマージ不可
  - DoD（完了条件）に「必要なADR/constraints更新」を含める

### リスク2：constraints が太って“第2の仕様書”になる
- 対策（恒久策）：
  - constraints は「前提/制約/非ゴール」だけに限定し、詳細はADRへ
  - 数字/バージョン/コマンドの固定記述は禁止（リンクに寄せる）

### リスク3：テストが弱く「合否がテストで決まらない」
- 対策（恒久策）：
  - 重要ロジック（課金/制限/広告表示条件/言語切替）はJestで固定
  - CIでJestを必須化（落ちたらマージ不可）

---

## 6. Links（参照）

- docs/reference/constraints.md
- docs/adr/README.md
- docs/adr/adr_template.md
